@page "/reporte-excel"
@rendermode InteractiveServer

@using TesoreriaMargaritas.Models
@using TesoreriaMargaritas.Services
@inject IErpService ErpService
@inject ExcelExportService ExcelService
@inject IJSRuntime JS

<PageTitle>Generar Reporte Excel</PageTitle>

@* Estilos locales para esta página *@
<style>
    .corporate-header {
        background-color: #9F1C0A; /* Rojo Corporativo */
        color: white;
        border-radius: 10px 10px 0 0;
    }

    .btn-corporate {
        background-color: #9F1C0A;
        color: white;
        border: none;
    }

        .btn-corporate:hover {
            background-color: #7c1608;
            color: #F8BD0B; /* Amarillo al pasar el mouse */
        }

    .form-control:focus, .form-select:focus {
        border-color: #F8BD0B; /* Amarillo Corporativo */
        box-shadow: 0 0 0 0.25rem rgba(248, 189, 11, 0.25);
    }

    .card-modern {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .icon-box {
        background-color: rgba(255, 255, 255, 0.2);
        padding: 8px;
        border-radius: 50%;
        margin-right: 15px;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">

            <div class="card card-modern">
                <div class="card-header corporate-header p-4 d-flex align-items-center">
                    <div class="icon-box">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-file-earmark-spreadsheet" viewBox="0 0 16 16">
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V9H3V2a1 1 0 0 1 1-1h5.5v2zM3 12v-2h2v2H3zm0 1h2v2H3v-2zm3 2v-2h3v2H6zm3-3h-3v-2h3v2zm4 0v-2h3v2h-3zm3 3h-3v-2h3v2zm-3-12h2v2h-2V3zm-3 2v2H6V3h3z" />
                        </svg>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold">Informe de Arqueos</h4>
                        <small class="text-white-50">Exportación detallada a Excel</small>
                    </div>
                </div>

                <div class="card-body p-5">
                    @if (mensajeError != null)
                    {
                        <div class="alert alert-danger d-flex align-items-center shadow-sm" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-3" viewBox="0 0 16 16">
                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                            </svg>
                            <div>
                                <strong>Error:</strong> @mensajeError
                            </div>
                            <button type="button" class="btn-close" @onclick="() => mensajeError = null"></button>
                        </div>
                    }

                    @if (mensajeExito != null)
                    {
                        <div class="alert alert-success d-flex align-items-center shadow-sm" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill flex-shrink-0 me-3" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                            </svg>
                            <div>
                                @mensajeExito
                            </div>
                            <button type="button" class="btn-close" @onclick="() => mensajeExito = null"></button>
                        </div>
                    }

                    @if (cargandoDatos)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted fw-light">Conectando con base de datos...</p>
                        </div>
                    }
                    else
                    {
                        <form @onsubmit="DescargarReporte">
                            <div class="row g-4">
                                <div class="col-12">
                                    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem; letter-spacing: 1px;">Filtros de Búsqueda</h6>
                                </div>

                                <!-- Rango de Fechas -->
                                <div class="col-md-6">
                                    <label for="fechaInicio" class="form-label fw-bold text-dark">Desde</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar"></i>📅</span>
                                        <input type="date" class="form-control border-start-0 ps-0" id="fechaInicio" @bind="fechaInicio" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="fechaFin" class="form-label fw-bold text-dark">Hasta</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar"></i>📅</span>
                                        <input type="date" class="form-control border-start-0 ps-0" id="fechaFin" @bind="fechaFin" required>
                                    </div>
                                </div>

                                <!-- Selector de Caja -->
                                <div class="col-12">
                                    <label for="cajaSelect" class="form-label fw-bold text-dark">Punto de Venta / Caja</label>
                                    <select class="form-select form-select-lg" id="cajaSelect" @bind="idCajaSeleccionadaString">
                                        <option value="">-- Todas las Cajas (Reporte General) --</option>
                                        @if (cajasDisponibles != null)
                                        {
                                            @foreach (var punto in cajasDisponibles)
                                            {
                                                <optgroup label="@punto.Titulo">
                                                    @foreach (var caja in punto.Cajas)
                                                    {
                                                        <option value="@caja.CajaFront">@caja.Descripcion (ID: @caja.CajaFront)</option>
                                                    }
                                                </optgroup>
                                            }
                                        }
                                    </select>
                                    <div class="form-text mt-2"><small>Seleccione una caja específica para ver el detalle de sus arqueos o deje en blanco para consolidado.</small></div>
                                </div>

                                <!-- Botones -->
                                <div class="col-12 mt-5 pt-3 border-top d-flex justify-content-between align-items-center">
                                    <a href="/" class="btn btn-outline-secondary px-4 rounded-pill">
                                        Volver
                                    </a>

                                    <button type="submit" class="btn btn-success px-4 py-2 rounded-pill shadow-sm d-flex align-items-center" disabled="@procesando">
                                        @if (procesando)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            <span>Procesando...</span>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                                            </svg>
                                            <span>Generar Excel</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </form>
                    }
                </div>
            </div>

            <div class="text-center mt-3">
                <small class="text-muted">Sistema de Tesorería Margaritas &copy; @DateTime.Now.Year</small>
            </div>

        </div>
    </div>
</div>

@code {
    private DateTime fechaInicio = DateTime.Now.AddDays(-7);
    private DateTime fechaFin = DateTime.Now;

    // Usamos string para el select HTML y luego parseamos
    private string idCajaSeleccionadaString = "";

    // Propiedad calculada de solo lectura (getter) que convierte el string a int?
    private int? idCajaSeleccionada => string.IsNullOrEmpty(idCajaSeleccionadaString) ? null : int.Parse(idCajaSeleccionadaString);

    private List<RemFront> cajasDisponibles = new List<RemFront>();
    private bool procesando = false;
    private bool cargandoDatos = true;
    private string? mensajeError;
    private string? mensajeExito;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarDatosIniciales();
            StateHasChanged();
        }
    }

    private async Task CargarDatosIniciales()
    {
        try
        {
            cargandoDatos = true;
            StateHasChanged();

            cajasDisponibles = await ErpService.ObtenerPuntosActivosConCajasAsync();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando cajas: {ex.Message}";
        }
        finally
        {
            cargandoDatos = false;
            StateHasChanged();
        }
    }

    private async Task DescargarReporte()
    {
        procesando = true;
        mensajeError = null;
        mensajeExito = null;
        await Task.Yield();

        try
        {
            // Lógica temporal para prueba: Usar la caja seleccionada o la primera disponible
            int cajaConsulta = idCajaSeleccionada ?? (cajasDisponibles?.FirstOrDefault()?.Cajas.FirstOrDefault()?.CajaFront ?? 0);

            if (cajaConsulta > 0)
            {
                var idFront = cajasDisponibles?.FirstOrDefault(p => p.Cajas.Any(c => c.CajaFront == cajaConsulta))?.IdFront ?? 0;

                // Obtenemos datos (Limitado a 30 días por el método actual del servicio)
                var data = await ErpService.ObtenerArqueosUltimos30Dias(idFront, cajaConsulta);

                // Filtrar por fechas seleccionadas en memoria
                var filtrados = data.Filas
                    .Where(f => f.Fecha.Date >= fechaInicio.Date && f.Fecha.Date <= fechaFin.Date)
                    .ToList();

                if (!filtrados.Any())
                {
                    mensajeError = "No se encontraron registros en el rango seleccionado.";
                }
                else
                {
                    var excelBytes = ExcelService.GenerarReporteArqueos(filtrados, data.EncabezadosPagos, "Reporte Arqueos");

                    var fileName = $"Reporte_Arqueos_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
                    await JS.InvokeVoidAsync("saveAsFile", fileName, Convert.ToBase64String(excelBytes));

                    mensajeExito = "Reporte descargado correctamente.";
                }
            }
            else
            {
                mensajeError = "No hay cajas disponibles para generar reporte.";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error generando reporte: {ex.Message}";
        }
        finally
        {
            procesando = false;
        }
    }
}